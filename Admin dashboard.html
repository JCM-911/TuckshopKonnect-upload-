<!DOCTYPE html>\n<!-- ... (HTML structure remains the same) ... -->\n\n    <!-- Scripts -->\n    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js\"></script>\n    <script src=\"https://cdn.jsdelivr.net/npm/chart.js\"></script>\n    \n    <script>\n        // Global state\n        let allUsers = [];\n        let allTransactions = [];\n        let allItems = [];\n        let currentUser = null; \n\n        // Session and Auth\n        document.addEventListener(\'DOMContentLoaded\', function() {\n            const token = sessionStorage.getItem(\'adminToken\');\n            currentUser = JSON.parse(sessionStorage.getItem(\'adminUser\'));\n\n            if (!token || !currentUser || currentUser.role !== \'admin\') {\n                sessionStorage.clear();\n                window.location.href = \'adminlogin.html\';\n                return;\n            }\n\n            setupAdminUI();\n            showSection(\'dashboard\');\n            addEventListeners();\n        });\n\n        function getAuthHeader() {\n            return { \'Authorization\': `Bearer ${sessionStorage.getItem(\'adminToken\')}` };\n        }\n\n        function setupAdminUI() {\n            document.getElementById(\'adminName\').textContent = currentUser.name || \'Administrator\';\n            document.getElementById(\'adminInitials\').textContent = (currentUser.name || \'A\').charAt(0).toUpperCase();\n        }\n\n        function logout() {\n            if (confirm(\'Are you sure you want to logout?\')) {\n                sessionStorage.clear();\n                window.location.href = \'adminlogin.html\';\n            }\n        }\n\n        // Navigation\n        function addEventListeners() {\n            document.querySelectorAll(\'.nav-link\').forEach(link => {\n                link.addEventListener(\'click\', function(e) {\n                    e.preventDefault();\n                    showSection(this.getAttribute(\'data-section\'));\n                });\n            });\n        }\n\n        async function showSection(sectionName) {\n            document.querySelectorAll(\'.section.active\').forEach(s => s.classList.remove(\'active\'));\n            document.getElementById(sectionName).classList.add(\'active\');\n\n            document.querySelectorAll(\'.nav-link.active\').forEach(l => l.classList.remove(\'active\'));\n            document.querySelector(`.nav-link[data-section=\"${sectionName}\"]`).classList.add(\'active\');\n            \n            document.getElementById(\'pageTitle\').textContent = document.querySelector(`.nav-link[data-section=\"${sectionName}\"] span`).textContent;\n\n            // Load data for the visible section\n            switch(sectionName) {\n                case \'dashboard\': await loadDashboardData(); break;\n                case \'parents\': await loadUsersData(\'parent\'); break;\n                case \'students\': await loadUsersData(\'student\'); break;\n                case \'items\': await loadItemsData(); break;\n                case \'transactions\': await loadTransactionsData(); break;\n                case \'reports\': initializeCharts(); break;\n            }\n        }\n\n        // Data Loading\n        async function loadDashboardData() {\n            await Promise.all([\n                loadUsersData(),\n                loadTransactionsData()\n            ]);\n            updateDashboardStats();\n        }\n\n        async function loadUsersData(role = null) {\n            try {\n                const url = role ? `/api/users?role=${role}` : \'/api/users\';\n                const res = await fetch(url, { headers: getAuthHeader() });\n                if (!res.ok) throw new Error(\'Failed to fetch users\');\n                \n                if (role) {\n                    const data = await res.json();\n                    if (role === \'parent\') renderParentsTable(data);\n                    if (role === \'student\') renderStudentsTable(data);\n                } else {\n                    allUsers = await res.json(); // For dashboard stats\n                }\n\n            } catch (error) {\n                showAlert(error.message, \'danger\');\n            }\n        }\n\n        async function loadItemsData() {\n            // Previously implemented item management logic\n        }\n\n        async function loadTransactionsData() {\n            try {\n                const res = await fetch(\'/api/transactions/all\', { headers: getAuthHeader() });\n                if (!res.ok) throw new Error(\'Failed to fetch transactions\');\n                allTransactions = await res.json();\n                renderTransactionsTable(allTransactions);\n            } catch (error) {\n                 showAlert(error.message, \'danger\');\n            }\n        }\n\n        // UI Rendering\n        function renderParentsTable(parents) {\n            const tbody = document.getElementById(\'parentsTable\');\n            tbody.innerHTML = \'\';\n            parents.forEach(p => {\n                const totalBalance = (p.children || []).reduce((acc, s) => acc + s.balance, 0);\n                tbody.innerHTML += `\n                    <tr>\n                        <td>${p.parentId}</td>\n                        <td>${p.name}</td>\n                        <td>${p.children.length}</td>\n                        <td>₦${totalBalance.toLocaleString()}</td>\n                        <td><span class=\"badge bg-success\">Active</span></td>\n                        <td>\n                           <button class=\"btn btn-info btn-sm\" onclick=\"openParentModal(\'${p._id}\')\">Edit</button>\n                           <button class=\"btn btn-danger btn-sm\" onclick=\"deleteUser(\'${p._id}\', \'parent\')\">Delete</button>\n                        </td>\n                    </tr>`;\n            });\n        }\n\n        function renderStudentsTable(students) {\n            const tbody = document.getElementById(\'studentsTable\');\n            tbody.innerHTML = \'\';\n            students.forEach(s => {\n                tbody.innerHTML += `\n                    <tr>\n                        <td>${s.studentId}</td>\n                        <td>${s.name}</td>\n                        <td>${s.class}</td>\n                        <td>₦${s.balance.toLocaleString()}</td>\n                        <td>${s.parent ? s.parent.name : \'N/A\'}</td>\n                        <td><span class=\"badge bg-success\">Active</span></td>\n                        <td>\n                           <button class=\"btn btn-info btn-sm\" onclick=\"openStudentModal(\'${s._id}\')\">Edit</button>\n                           <button class=\"btn btn-warning btn-sm\" onclick=\"openTopupModal(\'${s._id}\')\">Top-up</button>\n                           <button class=\"btn btn-danger btn-sm\" onclick=\"deleteUser(\'${s._id}\', \'student\')\">Delete</button>\n                        </td>\n                    </tr>`;\n            });\n        }\n\n        function renderTransactionsTable(transactions) {\n            // ... transaction rendering logic ...\n        }\n\n        function updateDashboardStats() {\n            const parents = allUsers.filter(u => u.role === \'parent\');\n            const students = allUsers.filter(u => u.role === \'student\');\n            const totalBalance = students.reduce((acc, s) => acc + s.balance, 0);\n            const lowBalanceCount = students.filter(s => s.balance < 500).length;\n\n            document.getElementById(\'totalParents\').textContent = parents.length;\n            document.getElementById(\'totalStudents\').textContent = students.length;\n            document.getElementById(\'totalBalance\').textContent = `₦${totalBalance.toLocaleString()}`;\n            document.getElementById(\'lowBalanceCount\').textContent = lowBalanceCount;\n        }\n\n        // User Management Modals & Actions\n        function openParentModal(id = null) {\n            // ... Logic to show/hide modal, populate with data if (id) for editing\n            new bootstrap.Modal(document.getElementById(\'parentModal\')).show();\n        }\n        \n        function openStudentModal(id = null) {\n            // ... Logic to show/hide modal, populate with data if (id) for editing\n             new bootstrap.Modal(document.getElementById(\'studentModal\')).show();\n        }\n\n        async function saveUser(event, role) {\n            event.preventDefault();\n            const form = event.target;\n            const id = form.querySelector(\'input[type=hidden]\').value;\n            const url = id ? `/api/users/${id}` : \'/api/users\';\n            const method = id ? \'PUT\' : \'POST\';\n\n            const body = {\n                role: role,\n                name: form.querySelector(\`#${role}Name\`).value,\n                // ... get other form fields ...\n            };\n\n            try {\n                const res = await fetch(url, {\n                    method,\n                    headers: { ...getAuthHeader(), \'Content-Type\': \'application/json\' },\n                    body: JSON.stringify(body)\n                });\n                if (!res.ok) throw new Error(await res.text());\n                showAlert(`Successfully saved ${role}.`, \'success\');\n                bootstrap.Modal.getInstance(form.closest(\'.modal\')).hide();\n                loadUsersData(role);\n                loadDashboardData(); // Refresh stats\n            } catch (error) {\n                showAlert(`Error: ${error.message}`, \'danger\');\n            }\n        }\n\n        async function deleteUser(id, role) {\n            if (!confirm(`Are you sure you want to delete this ${role}?`)) return;\n            try {\n                const res = await fetch(`/api/users/${id}`, { method: \'DELETE\', headers: getAuth-header() });\n                if (!res.ok) throw new Error(\'Failed to delete user\');\n                showAlert(\'User deleted successfully\', \'success\');\n                loadUsersData(role);\n                loadDashboardData(); // Refresh stats\n            } catch (error) {\n                showAlert(error.message, \'danger\');\n            }\n        }\n        \n        async function processTopup(event) {\n             event.preventDefault();\n             // ... topup logic using POST /api/transactions/topup ...\n        }\n\n        // ... (rest of the functions: top-up, alerts, charts, etc., adapted for API calls) ...\n\n    </script>\n</body>\n</html>